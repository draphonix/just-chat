Product Requirements Document: Universal Chat Popup - JWT Authentication (Version 1.2)1. Introduction / OverviewProduct: Universal Chat PopupVersion: 1.2 (JWT Authentication)Vision: To enhance the Universal Chat Popup with JWT-based authentication, providing a secure and standardized method for verifying the origin of chat messages and protecting the backend webhook from unauthorized access. This version will also include JWT generation and refresh capabilities.Goal: Implement a robust and secure JWT authentication mechanism that is compatible with both CDN and NPM installation methods. The widget will obtain an initial JWT and automatically refresh it as needed, minimizing the risk of token exposure and ensuring only authorized widgets can communicate with the backend.2. GoalsSecure Backend Communication: Ensure that all requests originating from the chat widget to the backend webhook are authenticated using JWTs.Prevent Unauthorized Access: Protect the backend from malicious or unintended requests.Standard Authentication: Implement a widely adopted and understood authentication standard (JWT).Flexible Integration: Support JWT authentication for both CDN and NPM installation methods.Automatic Token Management: The widget should handle obtaining an initial token and refreshing it as needed.Stateless Authentication: Utilize JWTs to maintain a stateless backend.Enhanced Security: Minimize the need for website owners to directly manage long-lived secrets within the widget configuration.Improved User Experience: Maintain chat functionality without requiring the user to manually re-authenticate.3. Target AudienceWebsite Owners: All users of the Universal Chat Popup who require secure communication between the widget and their backend servers.Web Developers: Developers integrating the chat widget into their websites or applications, who need to implement and manage the JWT authentication process.4. Key Features (Functional Requirements)4.1. Configuration Options:webhookUrl (Required): The URL of the backend endpoint that will process chat messages and also handle token requests.authType: (String, fixed value: 'jwt') Indicates the authentication type. This is a fixed value for this version.jwtConfig (Required): An object containing the necessary information for the widget to obtain and manage JWTs.issuer (Required): The identifier of the entity that issues the JWT.secretKey (Required): The shared secret used to sign the JWT.tokenEndpoint (Required): The endpoint on the server to request a new JWT.refreshInterval (Optional, default: 300): The interval in seconds at which the widget should attempt to refresh the JWT.expirationWindow (Optional, default: 60): The time in seconds before the JWT expiration when the widget should attempt to refresh the token.4.2. JWT Generation and Inclusion in Requests:Initial Token Request:When the widget initializes, it will make a request to the tokenEndpoint on the backend server to obtain an initial JWT.The request will include the issuer and any other necessary parameters.JWT Inclusion:The chat widget will include an Authorization header in every HTTP POST request to the webhookUrl.The value of the header will follow the Bearer <JWT_TOKEN> format.Token Refresh:The widget will track the expiration time of the current JWT.Before the JWT expires (based on expirationWindow), or at the interval specified by refreshInterval, the widget will send a request to the tokenEndpoint to obtain a new JWT.The refresh request will include the issuer and any other necessary parameters, potentially including the current JWT.4.3. Backend Authentication and Token Handling:Token Endpoint:The backend server will provide an endpoint at tokenEndpoint to handle JWT requests.The endpoint will:Validate the provided issuer.Verify the provided secretKey.Generate a new JWT with a short expiration time.Return the JWT in the response.Message Processing:The backend server will validate the JWT provided in the Authorization header of every request to the webhookUrl.The backend will use the HS256 algorithm and the shared secretKey to verify the JWT's signature.If the signature is invalid or the token is expired, the backend will reject the request with a 401 Unauthorized HTTP status code.4.4. Error Handling:If the backend responds with a 401 Unauthorized status code, the widget will:Display a user-friendly error message in the chat window, such as "Authentication failed. Chat functionality is temporarily unavailable. Please contact the website administrator."Log an error message to the browser's console for debugging purposes.Disable the message input field and the send button.If the token request to the tokenEndpoint fails, the widget will:Display a user-friendly error message in the chat window.Log an error to the consoleDisable the message input and send button4.5. Token Management:The widget will store the current JWT in memory.The widget will use the stored JWT for all requests to the webhookUrl.The widget will automatically refresh the JWT using the tokenEndpoint and the configured refreshInterval and expirationWindow.5. Non-Functional RequirementsSecurity:The widget must not expose the secretKey.  The secret key is only used on the backend.All communication between the widget and the backend must occur over HTTPS.The widget must only store the JWT in memory.Performance: The token request and refresh process should be performed efficiently and not negatively impact the chat widget's performance.Reliability: The widget should reliably obtain and refresh the JWT, ensuring that the Authorization header is always included in requests to the backend.Usability: The configuration process for setting up JWT authentication should be clearly documented and as straightforward as possible for website owners.Compatibility: The widget should function correctly with JWT authentication in all supported browsers.6. Design & UX ConsiderationsError Message: The error message displayed to the user when authentication fails (401) or when the token cannot be obtained should be clear, concise, and informative.Documentation: The documentation for setting up JWT authentication must be comprehensive and easy to follow, with clear instructions and examples for both CDN and NPM installations.  The documentation must clearly explain how the backend server should handle the token requests.Configuration: The configuration process should be as simple as possible.7. Technical ConsiderationsHTTP Headers: The Authorization header will be used to transmit the JWT.Request Method: The JWT will be included in the Authorization header of all POST requests to the webhookUrl.  The token request to the tokenEndpoint will also be a POST request.Error Handling: The widget will handle 401 Unauthorized responses from the backend and errors from the token endpoint.JavaScript: The widget will be implemented in JavaScript.Timing: Implement logic to refresh the token before it expires.8. Integration & Configuration Examples8.1. HTML Script Tag Method (CDN):<script src="<https://cdn.yourservice.com/widget-loader.js>"
        data-webhook-url="<https://your-secure-backend.com/process-chat>"
        data-jwt-issuer="my-app"
        data-jwt-token-endpoint="https://your-secure-backend.com/api/token"
        data-jwt-refresh-interval="300"
        data-theme-color="#1E40AF"
        data-position="bottom-right"
        data-title="Secure Chat"
        data-welcome-message="Welcome to our secure chat!"
        data-history-enabled="true"
        data-history-clear-button="false"
        defer>
</script>
8.2. NPM Package Method:import initChatPopup from 'universal-chat-popup';

initChatPopup({
    webhookUrl: 'https://your-secure-backend.com/process-chat',
    jwtConfig: {
        issuer: 'my-app',
        tokenEndpoint: 'https://your-secure-backend.com/api/token',
        refreshInterval: 300,
    },
    themeColor: '#1E40AF',
    position: 'bottom-right',
    title: 'Secure Chat',
    welcomeMessage: 'Welcome to our secure chat!',
    history: {
        enabled: true,
        clearButton: false
    }
});
9. Future Considerations / V.NextSupport other authentication methods (e.g., API keys).Provide more granular control over authorization scopes or permissions.Implement refresh token rotation.10. Open QuestionsWhat is the exact format of the request and response for the tokenEndpoint?What specific error message should be displayed to the user when the token request fails?Should we provide a way for the website owner to customize the error messages?Should we implement any logging or error reporting to our own servers when authentication fails or the token cannot be obtained? (Consider privacy).What is the minimum acceptable length and complexity for the secretKey? (This is a documentation issue, not a widget code issue).Should the widget attempt to reconnect automatically after an authentication failure? (This might be better handled by the website owner's application).How should the widget handle network connectivity issues during token refresh?11. Success MetricsNumber of websites successfully implementing JWT authentication with the chat widget.Number of support requests related to JWT authentication.Number of reported security vulnerabilities related to authentication.Uptime and reliability of the chat widget with JWT authentication enabled.Performance impact of adding the token refresh mechanism.
